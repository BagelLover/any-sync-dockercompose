FROM golang:1.19 as generator
RUN wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && \
    chmod +x /usr/bin/yq && \
    go install github.com/anyproto/any-sync-tools/anyconf@latest

WORKDIR /opt/generateconfig
COPY --chmod=777 docker-generateconfig/generate_config.sh .env .
RUN ./generate_config.sh

FROM alpine:3.18.4
RUN apk add --no-cache bash perl
WORKDIR /opt/processing
COPY docker-generateconfig/etc/ etc/
COPY --chmod=777 docker-generateconfig/processing.sh .
COPY --from=generator /opt/generateconfig/ generateconfig/

CMD ./processing.sh

